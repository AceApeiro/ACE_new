<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>ACE – Apeiro Citation Extractor (arXiv)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
body{margin:0;font-family:system-ui;background:#0b0f14;color:#e5e7eb}
button{cursor:pointer}
.bad{color:#ef4444}
.good{color:#22c55e}
.warn{color:#f59e0b}
textarea{width:100%;height:260px;background:#020617;color:#e5e7eb}
</style>
</head>

<body>
<h2>ACE – Apeiro Citation Extractor</h2>

<input type="file" id="zip" accept=".zip">
<button id="run">Run Extraction</button>

<pre id="log"></pre>
<textarea id="out"></textarea>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

const log = t => document.getElementById("log").textContent += t + "\n";

/* ===========================
   STRICT HTML CITE-AS (2ND LINE)
   =========================== */
function extractFromCiteAs(html){
  const text = html.replace(/\s+/g," ");
  const m = text.match(/\(or\s+arxiv:\s*(\d{4}\.\d{4,5})\s*(v\d+)\s+for\s+this\s+version\)/i);
  if(!m) return null;
  return {id:m[1], version:m[2]};
}

/* ===========================
   PDF TEXT
   =========================== */
async function pdfText(buf){
  const pdf = await pdfjsLib.getDocument({data:buf}).promise;
  let all="";
  for(let i=1;i<=pdf.numPages;i++){
    const p=await pdf.getPage(i);
    const t=await p.getTextContent();
    all+=t.items.map(x=>x.str).join("\n")+"\n";
  }
  return all;
}

/* ===========================
   KEYWORDS (STRICT)
   =========================== */
function extractKeywords(text){
  const lines=text.split("\n").map(l=>l.trim());
  const re=/^(keywords?|index terms|keywords and phrases|subject headings)\s*[:\-]/i;
  for(let i=0;i<lines.length;i++){
    if(re.test(lines[i])){
      return lines[i]
        .replace(re,"")
        .split(/[;,•]/)
        .map(x=>x.trim())
        .filter(x=>x.length>1);
    }
  }
  return [];
}

/* ===========================
   AFFILIATIONS (SURNAME LINK)
   =========================== */
function extractAffiliations(text, authors){
  const lines=text.split("\n").map(l=>l.trim()).filter(l=>l.length>10);
  const affs={};
  authors.forEach(a=>affs[a]=[]);
  lines.forEach(l=>{
    authors.forEach(a=>{
      if(new RegExp("\\b"+a+"\\b","i").test(l) &&
         /(university|institute|department|centre|center|school)/i.test(l)){
        affs[a].push(l);
      }
    });
  });
  return affs;
}

/* ===========================
   REFERENCES (CLEAN)
   =========================== */
function extractRefs(text){
  const idx=text.toLowerCase().lastIndexOf("references");
  if(idx<0) return [];
  return text.slice(idx)
    .split("\n")
    .map(l=>l.replace(/^\(?\d+\)?\.?\s*/,"").trim())
    .filter(l=>l.length>20);
}

/* ===========================
   MAIN
   =========================== */
document.getElementById("run").onclick=async()=>{
  log("Running…");

  const file=document.getElementById("zip").files[0];
  if(!file) return;

  const zip=await JSZip.loadAsync(await file.arrayBuffer());
  const pdfName=Object.keys(zip.files).find(n=>n.endsWith(".pdf"));
  const htmlName=Object.keys(zip.files).find(n=>n.endsWith(".html"));
  const apiName=Object.keys(zip.files).find(n=>n.toLowerCase().includes("api"));

  const pdfBuf=await zip.file(pdfName).async("uint8array");
  const pdfAll=await pdfText(pdfBuf);

  const html=await zip.file(htmlName).async("string");
  const cite=extractFromCiteAs(html);
  if(!cite){
    log("❌ HOLD: Cite-as second line missing");
    return;
  }

  const api=await zip.file(apiName).async("string");
  const authors=[...api.matchAll(/<keyname>([^<]+)</g)].map(m=>m[1]);

  const keywords=extractKeywords(pdfAll);
  const affiliations=extractAffiliations(pdfAll,authors);
  const refs=extractRefs(pdfAll);

  document.getElementById("out").value =
`ARXIV: ${cite.id}${cite.version}

KEYWORDS (${keywords.length})
${keywords.join(", ")}

AUTHORS / AFFILIATIONS
${authors.map(a=>a+" → "+(affiliations[a][0]||"NONE")).join("\n")}

REFERENCES (${refs.length})
${refs.slice(0,5).join("\n")}
`;
};
</script>
</body>
</html>
